function htmlToFigma(e="body",t=!1,o=!1){o&&console.time("Parse dom");const n=[],r=document.querySelector(e||"body");const i=e=>{if(!e)return null;const t=e.match(/([\d\.]+)px/),o=t&&t[1];return o?{unit:"PIXELS",value:parseFloat(o)}:null};function c(e){let t=e;do{const e=getComputedStyle(t);if("none"===e.display||"hidden"===e.visibility)return!0}while(t=t.parentElement);return!1}if(r){for(const e of Array.from(r.querySelectorAll("use")))try{const t=e.href.baseVal,o=document.querySelector(t);o&&(e.outerHTML=o.innerHTML)}catch(e){console.warn("Error querying <use> tag href",e)}const e=Array.from(r.querySelectorAll("*"));e&&Array.from(e).forEach(e=>{if(c(e))return;if(e instanceof SVGSVGElement){const t=e.getBoundingClientRect();return void n.push({type:"SVG",ref:e,svg:e.outerHTML,x:Math.round(t.left),y:Math.round(t.top),width:Math.round(t.width),height:Math.round(t.height)})}if(e instanceof SVGElement)return;const t=function(e,t){if(!(e instanceof HTMLElement||e instanceof SVGElement))return{};const o=getComputedStyle(e,t),n=o.color,r={transform:"none",opacity:"1",borderRadius:"0px",backgroundImage:"none",backgroundPosition:"0% 0%",backgroundSize:"auto",backgroundColor:"rgba(0, 0, 0, 0)",backgroundAttachment:"scroll",border:"0px none "+n,borderTop:"0px none "+n,borderBottom:"0px none "+n,borderLeft:"0px none "+n,borderRight:"0px none "+n,borderWidth:"0px",borderColor:n,borderStyle:"none",boxShadow:"none",fontWeight:"400",textAlign:"start",justifyContent:"normal",alignItems:"normal",alignSelf:"auto",flexGrow:"0",textDecoration:"none solid "+n,lineHeight:"normal",letterSpacing:"normal",backgroundRepeat:"repeat",zIndex:"auto"};return function(e,t){const o={};return t.forEach(t=>{e[t]&&e[t]!==r[t]&&(o[t]=e[t])}),o}(o,["opacity","backgroundColor","border","borderTop","borderLeft","borderRight","borderBottom","borderRadius","backgroundImage","borderColor","boxShadow"])}(e),o=getComputedStyle(e);if((function(e){return Object.keys(e).length}(t)||e instanceof HTMLImageElement||e instanceof HTMLVideoElement)&&"none"!==o.display){const t=e.getBoundingClientRect();if(t.width>=1&&t.height>=1){const r=[],c=l(o.backgroundColor);c&&r.push({type:"SOLID",color:{r:c.r,g:c.g,b:c.b},opacity:c.a||1});const s={type:"RECTANGLE",ref:e,x:Math.round(t.left),y:Math.round(t.top),width:Math.round(t.width),height:Math.round(t.height),fills:r};if(o.border){const e=o.border.match(/^([\d\.]+)px\s*(\w+)\s*(.*)$/);if(e){let[t,o,n,r]=e;if(o&&"0"!==o&&"none"!==n&&r){const e=l(r);e&&(s.strokes=[{type:"SOLID",color:{r:e.r,b:e.b,g:e.g},opacity:e.a||1}],s.strokeWeight=Math.round(parseFloat(o)))}}}if(!s.strokes){const r=e=>e[0].toUpperCase()+e.substring(1),i=["top","left","right","bottom"];for(const c of i){const i=o["border"+r(c)];if(i){const o=i.match(/^([\d\.]+)px\s*(\w+)\s*(.*)$/);if(o){let[r,i,s,a]=o;if(i&&"0"!==i&&"none"!==s&&a){const o=l(a);if(o){const r=["top","bottom"].includes(c)?t.width:parseFloat(i),l=["left","right"].includes(c)?t.height:parseFloat(i);n.push({ref:e,type:"RECTANGLE",x:"left"===c?t.left-r:"right"===c?t.right:t.left,y:"top"===c?t.top-l:"bottom"===c?t.bottom:t.top,width:r,height:l,fills:[{type:"SOLID",color:{r:o.r,b:o.b,g:o.g},opacity:o.a||1}]})}}}}}}if(o.backgroundImage&&"none"!==o.backgroundImage){const e=o.backgroundImage.match(/url\(['"]?(.*?)['"]?\)/),t=e&&e[1];t&&r.push({url:t,type:"IMAGE",scaleMode:"contain"===o.backgroundSize?"FIT":"FILL",imageHash:null})}if(e instanceof SVGSVGElement){const t=`data:image/svg+xml,${encodeURIComponent(e.outerHTML.replace(/\s+/g," "))}`;t&&r.push({url:t,type:"IMAGE",scaleMode:"FILL",imageHash:null})}if(e instanceof HTMLImageElement){const t=e.src;t&&r.push({url:t,type:"IMAGE",scaleMode:"contain"===o.objectFit?"FIT":"FILL",imageHash:null})}if(e instanceof HTMLVideoElement){const t=e.poster;t&&r.push({url:t,type:"IMAGE",scaleMode:"contain"===o.objectFit?"FIT":"FILL",imageHash:null})}if(o.boxShadow&&"none"!==o.boxShadow){const e=/^[0-9]+[a-zA-Z%]+?$/,t=e=>{if(!/px$/.test(e)&&"0"!==e)return 0;const t=parseFloat(e);return isNaN(t)?0:t},n=t=>"0"===t||e.test(t),r=(e=>{if(e.startsWith("rgb")){const t=e.match(/(rgba?\(.+?\))(.+)/);t&&(e=(t[2]+" "+t[1]).trim())}const o=e.split(/\s(?![^(]*\))/),r=o.includes("inset"),i=o.slice(-1)[0],c=n(i)?"rgba(0, 0, 0, 1)":i,l=o.filter(e=>"inset"!==e).filter(e=>e!==c).map(t),[s,a,d,f]=l;return{inset:r,offsetX:s,offsetY:a,blurRadius:d,spreadRadius:f,color:c}})(o.boxShadow),i=l(r.color);i&&(s.effects=[{color:i,type:"DROP_SHADOW",radius:r.blurRadius,blendMode:"NORMAL",visible:!0,offset:{x:r.offsetX,y:r.offsetY}}])}const a=i(o.borderTopLeftRadius);a&&(s.topLeftRadius=a.value);const d=i(o.borderTopRightRadius);d&&(s.topRightRadius=d.value);const f=i(o.borderBottomRightRadius);f&&(s.bottomRightRadius=f.value);const h=i(o.borderBottomLeftRadius);h&&(s.bottomLeftRadius=h.value),n.push(s)}}});const t=function(e){let t=null;const o=[],n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);for(;t=n.nextNode();)o.push(t);return o}(r);function l(e){if(!e)return null;const[t,o,n,r,i,c]=e.match(/rgba?\(([\d\.]+), ([\d\.]+), ([\d\.]+)(, ([\d\.]+))?\)/)||[],l=c&&0===parseFloat(c);return o&&n&&r&&!l?{r:parseInt(o)/255,g:parseInt(n)/255,b:parseInt(r)/255,a:c?parseFloat(c):1}:null}const o=e=>JSON.parse(JSON.stringify(e));for(const e of t)if(e.textContent&&e.textContent.trim().length){const t=e.parentElement;if(t){if(c(t))continue;const r=getComputedStyle(t),s=document.createRange();s.selectNode(e);const a=o(s.getBoundingClientRect()),d=i(r.lineHeight);if(s.detach(),d&&a.height<d.value){const e=d.value-a.height;a.top-=e/2,a.height=d.value}if(a.height<1||a.width<1)continue;const f={x:Math.round(a.left),ref:e,y:Math.round(a.top),width:Math.round(a.width),height:Math.round(a.height),type:"TEXT",characters:e.textContent.trim().replace(/\s+/g," ")||""},h=[],u=l(r.color);u&&h.push({type:"SOLID",color:{r:u.r,g:u.g,b:u.b},opacity:u.a||1}),h.length&&(f.fills=h);const p=i(r.letterSpacing);p&&(f.letterSpacing=p),d&&(f.lineHeight=d);const{textTransform:g}=r;switch(g){case"uppercase":f.textCase="UPPER";break;case"lowercase":f.textCase="LOWER";break;case"capitalize":f.textCase="TITLE"}const m=i(r.fontSize);m&&(f.fontSize=Math.round(m.value)),r.fontFamily&&(f.fontFamily=r.fontFamily),r.textDecoration&&("underline"!==r.textDecoration&&"strikethrough"!==r.textDecoration||(f.textDecoration=r.textDecoration.toUpperCase())),r.textAlign&&["left","center","right","justified"].includes(r.textAlign)&&(f.textAlignHorizontal=r.textAlign.toUpperCase()),n.push(f)}}}const s={type:"FRAME",width:Math.round(window.innerWidth),height:Math.round(document.documentElement.scrollHeight),x:0,y:0,ref:document.body};n.unshift(s);const a=e=>e&&Array.isArray(e.children);function d(e,t,o){e&&(t(e,o),a(e)&&e.children.forEach(o=>d(o,t,e)))}function f(e){e.concat([s]).forEach(e=>{d(e,e=>{delete e.ref})})}return t?(s.children=n.slice(1),function(){function e(e){let t=null;try{d(s,o=>{if(o&&o.children&&o.children.includes(e))throw t=o,"DONE"})}catch(e){"DONE"===e||console.error(e.message)}return t}const t=new WeakMap;n.forEach(e=>{e.ref&&t.set(e.ref,e)});let o=!0,r=0;for(;o;){if(o=!1,r++>1e4){console.error("Too many tree iterations 1");break}d(s,(n,r)=>{const i=n.ref;let c=i&&i.parentElement||null;do{if(c===document.body)break;if(c&&c!==document.body){const i=t.get(c);if(i===r)break;if(i&&i!==s){if(!a(i)){let l=i.ref;l&&l instanceof Node&&l.nodeType===Node.TEXT_NODE&&(l=l.parentElement);const s={type:"FRAME",clipsContent:!!(l instanceof Element&&"visible"!==getComputedStyle(l).overflow),x:i.x,y:i.y,width:i.width,height:i.height,ref:i.ref,backgrounds:[],children:[i,n]},a=e(i);if(!a){console.warn("\n\nCANT FIND PARENT\n",JSON.stringify(Object.assign({},i,{ref:null})));continue}if(r){const e=r.children.indexOf(n);r.children.splice(e,1)}delete i.ref;const d=a.children.indexOf(i);return t.set(c,s),a.children.splice(d,1,s),void(o=!0)}if(r){const e=r.children.indexOf(n);return r.children.splice(e,1),i.children.push(n),void(o=!0)}}}}while(c&&(c=c.parentElement))})}let i=!0,c=0;for(;i;){if(c++>1e4){console.error("Too many tree iterations 2");break}function l(e){let t=e instanceof Node&&e.nodeType===Node.TEXT_NODE?e.parentElement:e,o=[];for(;t&&(t=t.parentElement);)o.push(t);return o}function f(e){return l(e).length}i=!1,d(s,(e,o)=>{if(!i&&"FRAME"===e.type){const o=e.ref;if(e.children&&e.children.length>2){const n=e.children&&e.children.map(e=>e.ref);let r=e.ref,c=f(r);for(const t of n){const o=n.filter(e=>e!==t),i=l(t);for(const t of o){const o=l(t);for(const t of o)if(i.includes(t)&&e.ref.contains(t)){const e=f(t);e>c&&(r=t,c=e)}}}if(r&&r!==e.ref){const n=e.children.filter(e=>r.contains(e.ref));if(n.length!==e.children.length){const c=r.getBoundingClientRect(),l={type:"FRAME",clipsContent:!!(r instanceof Element&&"visible"!==getComputedStyle(r).overflow),ref:r,x:c.left,y:c.top,width:c.width,height:c.height,backgrounds:[],children:n};t.set(r,o);let s=e.children.length-1;for(const t of n){const o=e.children.indexOf(t);o>-1&&o<s&&(s=o)}e.children.splice(s,0,l);for(const t of n){const o=e.children.indexOf(t);o>-1&&e.children.splice(o,1)}i=!0}}}}})}d(s,e=>{if("FRAME"===e.type||"GROUP"===e.type){const{x:t,y:o}=e;(t||o)&&d(e,n=>{n!==e&&(n.x=n.x-t,n.y=n.y-o)})}})}(),function(e){e.concat([s]).forEach(e=>{d(e,t=>{if("SVG"===t.type)t.constraints={horizontal:"CENTER",vertical:"MIN"};else{let o=!1;const n=e.ref;if(n){const e=n instanceof Element?n:n.parentElement;if(e instanceof HTMLElement){const t=e.style.display;e.style.display="none";const n=getComputedStyle(e).width;e.style.display=t,n&&n.match(/^[\d\.]+px$/)&&(o=!0)}}t.constraints={horizontal:o?"CENTER":"SCALE",vertical:"MIN"}}})})}([s]),f([s]),o&&(console.info("\n"),console.timeEnd("Parse dom")),[s]):(f(n),o&&(console.info("\n"),console.timeEnd("Parse dom")),n)}
